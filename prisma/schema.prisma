// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum ContentType {
  TEXT
  IMAGE
  VIDEO
  MIXED
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  taughtClasses         Classroom[]            @relation("TeacherClasses")
  enrolledClasses       Enrollment[]
  lessonProgress        LessonProgress[]
  quizAttempts          QuizAttempt[]
  notifications         Notification[]
  comments              Comment[]
  reactions             Reaction[]
  paceVotes             PaceVote[]
  liveQuestions         LiveQuestion[]
  studentProfile        StudentProfile?
  studentIEPs           IEP[]                  @relation("StudentIEPs")
  teacherIEPs           IEP[]                  @relation("TeacherIEPs")
  iep                   IEP?                   @relation(fields: [iEPId], references: [id])
  iEPId                 String?
  parentChilds          ParentChild[]
  competencyProgresses  CompetencyProgress[]
  userBadges            UserBadge[]
  userPoints            UserPoints?
  portfolio             Portfolio?
  assignments           Assignment[]
  teacherAssignments    Assignment[]           @relation("TeacherAssignments")
  studentSubmissions    AssignmentSubmission[] @relation("StudentSubmissions")
  assignmentSubmissions AssignmentSubmission[]
  teacherRubrics        Rubric[]               @relation("TeacherRubrics")
  rubrics               Rubric[]
  observedLessons       LessonObservation[]    @relation("ObservedTeacher")
  conductedObservations LessonObservation[]    @relation("ObserverUser")
  announcements         Announcement[]
  teacherMeetings       PTMeeting[]            @relation("TeacherMeetings")
  studentMeetings       PTMeeting[]            @relation("StudentMeetings")
  emergencyAlerts       EmergencyAlert[]
  alertAcknowledgements AlertAcknowledgement[]
}

model Classroom {
  id          String   @id @default(cuid())
  name        String
  description String?
  teacher     User     @relation("TeacherClasses", fields: [teacherId], references: [id])
  teacherId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  enrollments        Enrollment[]
  subjects           Subject[]
  liveSessions       LiveSession[]
  ieps               IEP[]
  schoolTerms        SchoolTerm[]
  assignments        Assignment[]
  rubrics            Rubric[]
  lessonObservations LessonObservation[]
}

model Enrollment {
  id          String    @id @default(cuid())
  student     User      @relation(fields: [studentId], references: [id])
  studentId   String
  classroom   Classroom @relation(fields: [classroomId], references: [id])
  classroomId String
  createdAt   DateTime  @default(now())

  @@unique([studentId, classroomId])
}

model Subject {
  id          String    @id @default(cuid())
  name        String
  classroom   Classroom @relation(fields: [classroomId], references: [id])
  classroomId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  topics    Topic[]
  weekPlans WeekPlan[]
}

model Topic {
  id        String   @id @default(cuid())
  name      String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  subjectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subtopics Subtopic[]
  weekPlans WeekPlan[]
}

model Subtopic {
  id        String   @id @default(cuid())
  name      String
  topic     Topic    @relation(fields: [topicId], references: [id])
  topicId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lessons     Lesson[]
  quizzes     Quiz[]
  assignments Assignment[]
}

model Lesson {
  id          String      @id @default(cuid())
  title       String
  contentType ContentType
  text        String?
  imageUrl    String?
  videoUrl    String?
  subtopic    Subtopic    @relation(fields: [subtopicId], references: [id])
  subtopicId  String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  progress           LessonProgress[]
  comments           Comment[]
  lessonCompetencies LessonCompetency[]
}

model LessonProgress {
  id        String   @id @default(cuid())
  student   User     @relation(fields: [studentId], references: [id])
  studentId String
  lesson    Lesson   @relation(fields: [lessonId], references: [id])
  lessonId  String
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, lessonId])
}

model Quiz {
  id         String   @id @default(cuid())
  title      String
  subtopic   Subtopic @relation(fields: [subtopicId], references: [id])
  subtopicId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  questions        Question[]
  attempts         QuizAttempt[]
  quizCompetencies QuizCompetency[]
}

model Question {
  id            String   @id @default(cuid())
  text          String
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  correctAnswer String
  quiz          Quiz     @relation(fields: [quizId], references: [id])
  quizId        String
  createdAt     DateTime @default(now())
}

model QuizAttempt {
  id        String   @id @default(cuid())
  student   User     @relation(fields: [studentId], references: [id])
  studentId String
  quiz      Quiz     @relation(fields: [quizId], references: [id])
  quizId    String
  score     Int
  total     Int
  createdAt DateTime @default(now())

  @@unique([studentId, quizId])
}

model Notification {
  id        String   @id @default(cuid())
  message   String
  read      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  lesson    Lesson   @relation(fields: [lessonId], references: [id])
  lessonId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LiveSession {
  id                 String    @id @default(cuid())
  classroom          Classroom @relation(fields: [classroomId], references: [id])
  classroomId        String
  subtopicId         String
  currentLessonIndex Int       @default(0)
  active             Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  reactions Reaction[]
  paceVotes PaceVote[]
  questions LiveQuestion[]
}

model Reaction {
  id        String      @id @default(cuid())
  emoji     String
  student   User        @relation(fields: [studentId], references: [id])
  studentId String
  session   LiveSession @relation(fields: [sessionId], references: [id])
  sessionId String
  createdAt DateTime    @default(now())
}

model PaceVote {
  id        String      @id @default(cuid())
  vote      String
  student   User        @relation(fields: [studentId], references: [id])
  studentId String
  session   LiveSession @relation(fields: [sessionId], references: [id])
  sessionId String
  createdAt DateTime    @default(now())

  @@unique([studentId, sessionId])
}

model LiveQuestion {
  id        String      @id @default(cuid())
  text      String
  student   User        @relation(fields: [studentId], references: [id])
  studentId String
  session   LiveSession @relation(fields: [sessionId], references: [id])
  sessionId String
  answered  Boolean     @default(false)
  createdAt DateTime    @default(now())
}

model StudentProfile {
  id        String   @id @default(cuid())
  student   User     @relation(fields: [studentId], references: [id])
  studentId String   @unique
  strengths String?
  concerns  String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model IEP {
  id                 String    @id @default(cuid())
  student            User      @relation("StudentIEPs", fields: [studentId], references: [id])
  studentId          String
  classroom          Classroom @relation(fields: [classroomId], references: [id])
  classroomId        String
  teacher            User      @relation("TeacherIEPs", fields: [teacherId], references: [id])
  teacherId          String
  strengths          String?
  areasOfConcern     String?
  learningGoals      String?
  interventions      String?
  reviewDate         DateTime?
  status             String    @default("DRAFT")
  parentAcknowledged Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  reviews IEPReview[]

  users User[]
}

model IEPReview {
  id        String   @id @default(cuid())
  iep       IEP      @relation(fields: [iepId], references: [id])
  iepId     String
  notes     String?
  createdAt DateTime @default(now())
}

model Parent {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  children   ParentChild[]
  ptmeetings PTMeeting[]
}

model ParentChild {
  id        String   @id @default(cuid())
  parent    Parent   @relation(fields: [parentId], references: [id])
  parentId  String
  student   User     @relation(fields: [studentId], references: [id])
  studentId String
  createdAt DateTime @default(now())

  @@unique([parentId, studentId])
}

model Competency {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  createdAt   DateTime @default(now())

  lessonCompetencies LessonCompetency[]
  quizCompetencies   QuizCompetency[]
  competencyProgress CompetencyProgress[]
}

model LessonCompetency {
  id           String     @id @default(cuid())
  lesson       Lesson     @relation(fields: [lessonId], references: [id])
  lessonId     String
  competency   Competency @relation(fields: [competencyId], references: [id])
  competencyId String

  @@unique([lessonId, competencyId])
}

model QuizCompetency {
  id           String     @id @default(cuid())
  quiz         Quiz       @relation(fields: [quizId], references: [id])
  quizId       String
  competency   Competency @relation(fields: [competencyId], references: [id])
  competencyId String

  @@unique([quizId, competencyId])
}

model CompetencyProgress {
  id           String     @id @default(cuid())
  student      User       @relation(fields: [studentId], references: [id])
  studentId    String
  competency   Competency @relation(fields: [competencyId], references: [id])
  competencyId String
  level        String     @default("BEGINNING")
  updatedAt    DateTime   @updatedAt

  @@unique([studentId, competencyId])
}

model Badge {
  id          String   @id @default(cuid())
  name        String
  description String
  icon        String
  condition   String
  createdAt   DateTime @default(now())

  userBadges UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  badge     Badge    @relation(fields: [badgeId], references: [id])
  badgeId   String
  createdAt DateTime @default(now())

  @@unique([userId, badgeId])
}

model UserPoints {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  points    Int      @default(0)
  streak    Int      @default(0)
  lastLogin DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Portfolio {
  id        String   @id @default(cuid())
  student   User     @relation(fields: [studentId], references: [id])
  studentId String   @unique
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items PortfolioItem[]
}

model PortfolioItem {
  id          String    @id @default(cuid())
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id])
  portfolioId String
  title       String
  description String?
  type        String
  content     String?
  fileUrl     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model SchoolTerm {
  id          String    @id @default(cuid())
  name        String
  startDate   DateTime
  endDate     DateTime
  classroom   Classroom @relation(fields: [classroomId], references: [id])
  classroomId String
  createdAt   DateTime  @default(now())

  weekPlans WeekPlan[]
}

model WeekPlan {
  id         String     @id @default(cuid())
  term       SchoolTerm @relation(fields: [termId], references: [id])
  termId     String
  weekNumber Int
  subject    Subject    @relation(fields: [subjectId], references: [id])
  subjectId  String
  topic      Topic      @relation(fields: [topicId], references: [id])
  topicId    String
  notes      String?
  completed  Boolean    @default(false)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Assignment {
  id          String    @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  totalMarks  Int       @default(100)
  classroom   Classroom @relation(fields: [classroomId], references: [id])
  classroomId String
  teacher     User      @relation("TeacherAssignments", fields: [teacherId], references: [id])
  teacherId   String
  subtopic    Subtopic? @relation(fields: [subtopicId], references: [id])
  subtopicId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  submissions AssignmentSubmission[]
  user        User?                  @relation(fields: [userId], references: [id])
  userId      String?
  rubric      Rubric?                @relation(fields: [rubricId], references: [id])
  rubricId    String?
}

model AssignmentSubmission {
  id           String        @id @default(cuid())
  assignment   Assignment    @relation(fields: [assignmentId], references: [id])
  assignmentId String
  student      User          @relation("StudentSubmissions", fields: [studentId], references: [id])
  studentId    String
  content      String?
  fileUrl      String?
  marks        Int?
  feedback     String?
  status       String        @default("SUBMITTED")
  submittedAt  DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User?         @relation(fields: [userId], references: [id])
  userId       String?
  rubricScores RubricScore[]

  @@unique([assignmentId, studentId])
}

model Rubric {
  id          String    @id @default(cuid())
  title       String
  description String?
  classroom   Classroom @relation(fields: [classroomId], references: [id])
  classroomId String
  teacher     User      @relation("TeacherRubrics", fields: [teacherId], references: [id])
  teacherId   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  criteria    RubricCriteria[]
  assignments Assignment[]
  user        User?            @relation(fields: [userId], references: [id])
  userId      String?
}

model RubricCriteria {
  id          String   @id @default(cuid())
  rubric      Rubric   @relation(fields: [rubricId], references: [id])
  rubricId    String
  name        String
  description String?
  maxScore    Int      @default(4)
  weight      Int      @default(1)
  createdAt   DateTime @default(now())

  scores RubricScore[]
}

model RubricScore {
  id           String               @id @default(cuid())
  criteria     RubricCriteria       @relation(fields: [criteriaId], references: [id])
  criteriaId   String
  submission   AssignmentSubmission @relation(fields: [submissionId], references: [id])
  submissionId String
  score        Int
  comment      String?
  createdAt    DateTime             @default(now())

  @@unique([criteriaId, submissionId])
}

model LessonObservation {
  id          String    @id @default(cuid())
  teacher     User      @relation("ObservedTeacher", fields: [teacherId], references: [id])
  teacherId   String
  observer    User      @relation("ObserverUser", fields: [observerId], references: [id])
  observerId  String
  classroom   Classroom @relation(fields: [classroomId], references: [id])
  classroomId String
  date        DateTime
  topic       String
  status      String    @default("SCHEDULED")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  ratings  ObservationRating[]
  comments ObservationComment[]
}

model ObservationRating {
  id            String            @id @default(cuid())
  observation   LessonObservation @relation(fields: [observationId], references: [id])
  observationId String
  criteria      String
  rating        Int
  createdAt     DateTime          @default(now())

  @@unique([observationId, criteria])
}

model ObservationComment {
  id            String            @id @default(cuid())
  observation   LessonObservation @relation(fields: [observationId], references: [id])
  observationId String
  type          String
  comment       String
  createdAt     DateTime          @default(now())
}

model Announcement {
  id          String   @id @default(cuid())
  title       String
  body        String
  author      User     @relation(fields: [authorId], references: [id])
  authorId    String
  audience    String   @default("ALL")
  classroomId String?
  pinned      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reads AnnouncementRead[]
}

model AnnouncementRead {
  id             String       @id @default(cuid())
  announcement   Announcement @relation(fields: [announcementId], references: [id])
  announcementId String
  userId         String
  createdAt      DateTime     @default(now())

  @@unique([announcementId, userId])
}

model PTMeeting {
  id        String   @id @default(cuid())
  teacher   User     @relation("TeacherMeetings", fields: [teacherId], references: [id])
  teacherId String
  parent    Parent   @relation(fields: [parentId], references: [id])
  parentId  String
  student   User     @relation("StudentMeetings", fields: [studentId], references: [id])
  studentId String
  date      DateTime
  duration  Int      @default(30)
  venue     String?
  agenda    String?
  notes     String?
  status    String   @default("SCHEDULED")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmergencyAlert {
  id        String   @id @default(cuid())
  title     String
  message   String
  severity  String   @default("HIGH")
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  acknowledgements AlertAcknowledgement[]
}

model AlertAcknowledgement {
  id        String         @id @default(cuid())
  alert     EmergencyAlert @relation(fields: [alertId], references: [id])
  alertId   String
  userId    String
  createdAt DateTime       @default(now())
  user      User           @relation(fields: [userId], references: [id])

  @@unique([alertId, userId])
}
